<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contest Admin - $NUTS Sports Pick'em</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="src/assets/images/nuts-logo.jpg">
    
    <!-- Styles -->
    <link rel="stylesheet" href="src/css/styles.css">
    
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        
        .entries-table {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
        }
        
        .entries-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .entries-table th {
            background: #2a2a2a;
            padding: 15px;
            text-align: left;
            color: #ffa500;
            font-weight: 600;
            border-bottom: 2px solid #444;
        }
        
        .entries-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
        }
        
        .entries-table tr:hover {
            background: #252525;
        }
        
        .picks-preview {
            font-size: 0.85em;
            color: #888;
        }
        
        .score-badge {
            background: #4CAF50;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .date-selector {
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: #4CAF50;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .refresh-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <!-- Password Protection Modal -->
    <div id="password-modal" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    ">
        <div style="
            background: #1a1a1a;
            border: 2px solid #ff6b00;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        ">
            <img src="src/assets/images/nuts-logo.jpg" alt="$NUTS Logo" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 20px;">
            <h2 style="color: #ff6b00; margin-bottom: 10px;">Admin Access Required</h2>
            <p style="color: #ccc; margin-bottom: 20px;">Please enter the admin password to continue</p>
            
            <input type="password" id="admin-password" placeholder="Enter password" style="
                background: #2a2a2a;
                border: 1px solid #444;
                color: white;
                padding: 12px 15px;
                border-radius: 8px;
                width: 100%;
                margin-bottom: 15px;
                font-size: 16px;
            " onkeypress="if(event.key === 'Enter') checkPassword()">
            
            <button onclick="checkPassword()" style="
                background: #ff6b00;
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
            ">Enter Admin Area</button>
            
            <p id="password-error" style="color: #ff4444; margin-top: 15px; display: none;">
                Incorrect password. Please try again.
            </p>
        </div>
    </div>

    <script>
        // Check if already authenticated
        const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
        if (isAuthenticated) {
            document.getElementById('password-modal').style.display = 'none';
        }

        function checkPassword() {
            const password = document.getElementById('admin-password').value;
            const correctPassword = 'NutS420!!';
            
            if (password === correctPassword) {
                // Store authentication in session
                sessionStorage.setItem('adminAuthenticated', 'true');
                document.getElementById('password-modal').style.display = 'none';
            } else {
                // Show error
                document.getElementById('password-error').style.display = 'block';
                document.getElementById('admin-password').value = '';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    document.getElementById('password-error').style.display = 'none';
                }, 3000);
            }
        }

        // Focus on password input
        window.addEventListener('load', () => {
            if (!isAuthenticated) {
                document.getElementById('admin-password').focus();
            }
        });
    </script>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="src/assets/images/nuts-logo.jpg" alt="$NUTS Logo" class="logo" style="width: 40px; height: 40px; border-radius: 50%;">
                <span class="brand-text">$NUTS Admin</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="daily-contest.html" class="nav-link">Contest</a>
                <a href="admin-games-upload.html" class="nav-link">Upload Games</a>
                <a href="admin-contest.html" class="nav-link active">Contest Admin</a>
            </div>
        </div>
    </nav>

    <main class="admin-container">
        <h1 style="color: #ffa500; margin-bottom: 30px;">Contest Administration</h1>
        
        <!-- Date Selector -->
        <div style="margin-bottom: 30px;">
            <label style="margin-right: 10px;">Contest Date:</label>
            <input type="date" id="contest-date" class="date-selector">
            <button onclick="loadContestData()" class="refresh-btn">Load Data</button>
            <button onclick="clearSelectedDateData()" class="refresh-btn" style="background: #ff4444; margin-left: 10px;">Clear Data</button>
            <button onclick="clearAllContestData()" class="refresh-btn" style="background: #ff6600; margin-left: 5px;">Clear All</button>
            <button onclick="clearTestData()" class="refresh-btn" style="background: #ff0000; margin-left: 5px;">Clear Test Data</button>
        </div>
        
        <!-- Statistics -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <h3>Total Entries</h3>
                <div class="stat-value" id="total-entries">0</div>
            </div>
            <div class="stat-card">
                <h3>Prize Pool</h3>
                <div class="stat-value" id="prize-pool">0 NUTS</div>
            </div>
            <div class="stat-card">
                <h3>Contest Status</h3>
                <div class="stat-value" id="contest-status">Pending</div>
            </div>
            <div class="stat-card">
                <h3>Average Score</h3>
                <div class="stat-value" id="avg-score">0</div>
            </div>
        </div>
        
        <!-- Entries Table -->
        <div class="entries-table">
            <h2 style="padding: 20px; color: #ffa500;">Contest Entries</h2>
            <table>
                <thead>
                    <tr>
                        <th>Entry ID</th>
                        <th>User</th>
                        <th>X Handle</th>
                        <th>Wallet</th>
                        <th>Picks</th>
                        <th>Tiebreaker</th>
                        <th>Score</th>
                        <th>Prize</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="entries-tbody">
                    <tr>
                        <td colspan="10" style="text-align: center; color: #888;">
                            Select a date and click Load Data
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Actions -->
        <div style="margin-top: 30px; text-align: center;">
            <button onclick="calculateWinners()" class="btn btn-primary" style="margin-right: 10px;">
                Calculate Winners
            </button>
            <button onclick="completeContest()" class="btn btn-primary" style="margin-right: 10px; background: #ff9900;">
                Complete Contest
            </button>
            <button onclick="exportData()" class="btn btn-secondary">
                Export to CSV
            </button>
        </div>
    </main>

    <!-- Payout Modal -->
    <div id="payout-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="background: #1a1a1a; border: 2px solid #ff6b00; border-radius: 12px; padding: 30px; margin: 50px auto; max-width: 600px; position: relative;">
            <button onclick="closePayoutModal()" style="position: absolute; top: 10px; right: 10px; background: #ff6b00; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">×</button>
            
            <h2 style="color: #ff6b00; margin-bottom: 20px;">Manual Payout Process</h2>
            
            <div style="background: #ff3333; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <strong>⚠️ IMPORTANT: All payouts must be sent manually through your Xaman wallet</strong>
            </div>
            
            <div id="payout-details" style="margin-bottom: 20px;">
                <!-- Details will be populated dynamically -->
            </div>
            
            <div style="display: flex; gap: 20px; margin-top: 30px;">
                <button onclick="showManualPayment()" style="flex: 1; background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    📋 Show Manual Payment Info
                </button>
                <button onclick="generatePayoutQR()" style="flex: 1; background: #ff6b00; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    📱 Generate QR Code
                </button>
            </div>
            
            <div id="payment-method-content" style="margin-top: 20px;">
                <!-- Payment method content will appear here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config/config-browser.js"></script>
    <script src="config/environment.js"></script>
    <script src="src/js/firebase-integration.js"></script>
    <script src="src/js/firebase-xaman-integration.js"></script>
    <script src="src/js/contest-backend.js"></script>
    
    <script>
        let integration;
        let backend;
        let currentEntries = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('contest-date').value = today;
            
            // Initialize Firebase integration first
            console.log('🔥 Setting up Firebase integration...');
            window.firebaseIntegration = new FirebaseIntegration();
            await window.firebaseIntegration.initialize();
            
            // Initialize Firebase + Xaman integration
            integration = new FirebaseXamanIntegration();
            await integration.init();
            
            // Initialize backend
            backend = new ContestBackend();
            await backend.init();
            
            // Load today's data
            loadContestData();
        });
        
        async function loadContestData() {
            const dateInput = document.getElementById('contest-date');
            const contestDate = dateInput.value;
            
            if (!contestDate) {
                alert('Please select a date');
                return;
            }
            
            try {
                console.log('🔄 Loading data for', contestDate);
                console.log('🔄 Firebase enabled:', integration?.firebase?.initialized);
                console.log('🔄 Backend enabled:', backend?.firebaseEnabled);
                
                // Debug: Show what's in localStorage for ALL possible keys
                const possibleKeys = [
                    `contest_entries_${contestDate}`,
                    `entries_${contestDate}`,
                    'contest_entries',
                    'entries'
                ];
                
                console.log('🔍 Checking ALL localStorage keys:');
                possibleKeys.forEach(key => {
                    const data = localStorage.getItem(key);
                    console.log(`  ${key}:`, data ? `${data.length} chars` : 'EMPTY');
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            console.log(`    Entries count: ${Array.isArray(parsed) ? parsed.length : 'not array'}`);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                console.log(`    First entry:`, parsed[0]);
                            }
                        } catch (e) {
                            console.log(`    Parse error:`, e.message);
                        }
                    }
                });
                
                // Also check ALL localStorage keys
                console.log('🔍 ALL localStorage keys:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('contest') || key.includes('entries'))) {
                        const data = localStorage.getItem(key);
                        console.log(`  ${key}: ${data ? data.length + ' chars' : 'EMPTY'}`);
                    }
                }
                
                // Get entries
                currentEntries = await integration.getContestEntries(contestDate);
                console.log('📊 Final loaded entries:', currentEntries.length, currentEntries.length > 0 ? currentEntries[0] : 'none');
                
                // Get stats
                const stats = await integration.getContestStats(contestDate);
                
                // Update UI
                updateStats(stats);
                updateEntriesTable(currentEntries);
                
            } catch (error) {
                console.error('Failed to load data:', error);
                alert('Failed to load contest data: ' + error.message);
            }
        }
        
        function updateStats(stats) {
            document.getElementById('total-entries').textContent = stats.totalEntries;
            document.getElementById('prize-pool').textContent = stats.prizePool + ' NUTS';
            document.getElementById('contest-status').textContent = 
                stats.totalEntries >= 2 ? 'Active' : 'Needs ' + (2 - stats.totalEntries) + ' more';
            document.getElementById('avg-score').textContent = stats.avgScore.toFixed(1);
        }
        
        function updateEntriesTable(entries) {
            const tbody = document.getElementById('entries-tbody');
            
            if (entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #888;">
                            No entries for this date
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td style="font-family: monospace; font-size: 0.85em;">
                        ${entry.id.substring(0, 12)}...
                    </td>
                    <td>${entry.userName}</td>
                    <td>
                        ${entry.twitterHandle ? 
                            `<a href="https://twitter.com/${entry.twitterHandle.replace('@', '')}" 
                                target="_blank" 
                                style="color: #1DA1F2; text-decoration: none;">
                                ${entry.twitterHandle}
                            </a>` : 
                            '<span style="color: #666;">-</span>'}
                    </td>
                    <td style="font-family: monospace; font-size: 0.75em;">
                        ${entry.walletAddress ? 
                            `<span title="${entry.walletAddress}" style="cursor: help;">
                                ${entry.walletAddress.substring(0, 8)}...${entry.walletAddress.substring(entry.walletAddress.length - 4)}
                            </span>` : 
                            '<span style="color: #666;">-</span>'}
                    </td>
                    <td class="picks-preview">
                        ${Object.keys(entry.picks || {}).length} picks
                    </td>
                    <td>${entry.tiebreakerRuns || 0} runs</td>
                    <td>
                        ${entry.score !== undefined ? 
                            `<span class="score-badge">${entry.score}</span>` : 
                            '<span style="color: #666;">-</span>'}
                    </td>
                    <td>${entry.prizeWon || 0} NUTS</td>
                    <td>
                        <span style="color: ${
                            entry.status === 'won' ? '#4CAF50' : 
                            entry.status === 'active' ? '#2196F3' : '#888'
                        }">
                            ${entry.status || 'pending'}
                        </span>
                        ${entry.contestStatus === 'completed' ? 
                            '<br><small style="color: #ff9900;">Completed</small>' : 
                            ''}
                        ${entry.status === 'won' && entry.prizeWon > 0 ? `
                            <div style="margin-top: 5px;">
                                <button onclick="showPayoutOptions('${entry.id}')" 
                                        class="btn btn-sm" 
                                        style="background: #ff6b00; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                    Pay Winner
                                </button>
                            </div>
                        ` : ''}
                    </td>
                    <td style="font-size: 0.85em; color: #888;">
                        ${new Date(entry.timestamp || entry.paymentTimestamp).toLocaleTimeString()}
                    </td>
                </tr>
            `).join('');
        }
        
        async function calculateWinners() {
            const minimumEntries = window.config?.contest?.minimumEntries || 4;
            
            if (currentEntries.length < minimumEntries) {
                const confirmRefund = confirm(
                    `Only ${currentEntries.length} entries (minimum ${minimumEntries} required).\n\n` +
                    `The contest will be cancelled and all entry fees will be refunded.\n\n` +
                    `Process refunds?`
                );
                
                if (confirmRefund) {
                    await processRefunds();
                }
                return;
            }
            
            // In production, this would get actual game results
            const mockGameResults = {};
            currentEntries[0].picks && Object.keys(currentEntries[0].picks).forEach(gameId => {
                mockGameResults[gameId] = {
                    winner: Math.random() > 0.5 ? 'home' : 'away'
                };
            });
            mockGameResults.lastGameRuns = Math.floor(Math.random() * 15) + 5;
            
            try {
                const result = await integration.updateGameResults(
                    document.getElementById('contest-date').value,
                    mockGameResults
                );
                
                if (result) {
                    if (result.status === 'cancelled') {
                        alert(`Contest cancelled: ${result.reason}\nRefunds required for ${result.totalEntries} entries.`);
                        await processRefunds();
                    } else if (result.winners) {
                        // Show winners
                        let winnerMessage = '🏆 CONTEST RESULTS 🏆\n\n';
                        winnerMessage += `Total Prize Pool: ${result.prizePool} NUTS\n\n`;
                        
                        result.winners.forEach(winner => {
                            const placeEmoji = winner.place === 1 ? '🥇' : winner.place === 2 ? '🥈' : '🥉';
                            winnerMessage += `${placeEmoji} ${winner.place === 1 ? '1st' : winner.place === 2 ? '2nd' : '3rd'} Place: ${winner.entry.userName}\n`;
                            winnerMessage += `   Score: ${winner.entry.score} correct picks\n`;
                            winnerMessage += `   Prize: ${winner.prize} NUTS\n\n`;
                        });
                        
                        winnerMessage += '\n\n📋 NOTE: All payouts are MANUAL\nClick OK to view payout details for each winner.';
                        
                        if (confirm(winnerMessage)) {
                            await processAllPayouts(result.winners);
                        }
                    }
                    
                    loadContestData(); // Reload to show updated data
                }
            } catch (error) {
                alert('Failed to calculate winners: ' + error.message);
            }
        }
        
        async function processRefunds() {
            try {
                const contestDate = document.getElementById('contest-date').value;
                
                // Use the backend's refund method
                if (window.ContestBackend) {
                    const backend = new ContestBackend();
                    await backend.init();
                    
                    const result = await backend.processRefunds(contestDate);
                    
                    if (result.success) {
                        alert(
                            `✅ Refunds Processed!\n\n` +
                            `Entries refunded: ${result.entriesRefunded}\n` +
                            `Total refund amount: ${result.totalRefundAmount} NUTS\n\n` +
                            `Please process the refunds manually through Xaman wallet.`
                        );
                    } else {
                        alert('Failed to process refunds: ' + result.error);
                    }
                } else {
                    alert('Contest backend not available');
                }
                
                loadContestData(); // Reload data
                
            } catch (error) {
                console.error('Failed to process refunds:', error);
                alert('Error processing refunds: ' + error.message);
            }
        }
        
        async function processAllPayouts(winners) {
            try {
                let successCount = 0;
                
                for (const winner of winners) {
                    const entry = winner.entry;
                    
                    if (!entry.walletAddress) {
                        alert(`⚠️ No wallet address for ${entry.userName}. Please process manually.`);
                        continue;
                    }
                    
                    // Show payout modal for each winner
                    showPayoutOptions(entry.id);
                    
                    // Wait for user to process this payout before continuing
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (!document.getElementById('payout-modal').style.display || 
                                document.getElementById('payout-modal').style.display === 'none') {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 1000);
                    });
                    
                    successCount++;
                }
                
                alert(`✅ Processed ${successCount} payouts!`);
                
            } catch (error) {
                console.error('Failed to process payouts:', error);
                alert('Error processing payouts: ' + error.message);
            }
        }
        
        function exportData() {
            if (currentEntries.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create CSV
            const headers = ['Entry ID', 'User', 'X Handle', 'Wallet Address', 'Picks', 'Tiebreaker', 'Score', 'Prize', 'Status', 'Timestamp'];
            const rows = currentEntries.map(e => [
                e.id,
                e.userName,
                e.twitterHandle || '',
                e.walletAddress || '',
                Object.keys(e.picks || {}).length,
                e.tiebreakerRuns || 0,
                e.score || 0,
                e.prizeWon || 0,
                e.status || 'pending',
                new Date(e.timestamp || e.paymentTimestamp).toISOString()
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contest_entries_${document.getElementById('contest-date').value}.csv`;
            a.click();
        }
        
        // Payout functions
        let currentPayoutEntry = null;
        
        function showPayoutOptions(entryId) {
            const entry = currentEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            currentPayoutEntry = entry;
            
            // Show modal
            document.getElementById('payout-modal').style.display = 'block';
            
            // Populate details
            document.getElementById('payout-details').innerHTML = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #4CAF50; margin-bottom: 15px;">Winner Details</h3>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; color: #ccc;">
                        <div>Winner:</div>
                        <div style="color: white; font-weight: bold;">${entry.userName}</div>
                        
                        <div>Prize Amount:</div>
                        <div style="color: #ff6b00; font-weight: bold; font-size: 1.2em;">${entry.prizeWon} NUTS</div>
                        
                        <div>Contest Date:</div>
                        <div>${entry.contestDate}</div>
                        
                        <div>Correct Picks:</div>
                        <div>${entry.score} / ${entry.totalGames}</div>
                        
                        <div>Entry ID:</div>
                        <div style="font-family: monospace; font-size: 0.9em;">${entry.id}</div>
                    </div>
                </div>
            `;
            
            // Clear payment method content
            document.getElementById('payment-method-content').innerHTML = '';
        }
        
        function closePayoutModal() {
            document.getElementById('payout-modal').style.display = 'none';
            currentPayoutEntry = null;
        }
        
        function showManualPayment() {
            if (!currentPayoutEntry) return;
            
            // Get wallet address from entry
            const walletAddress = currentPayoutEntry.walletAddress || 'Not captured - check payment transaction';
            
            document.getElementById('payment-method-content').innerHTML = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 2px solid #4CAF50;">
                    <h3 style="color: #4CAF50; margin-bottom: 15px;">📋 Manual Payment Instructions</h3>
                    
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #ff6b00; font-weight: bold; margin-bottom: 10px;">Step 1: Copy Payment Details</p>
                        <div style="color: #ccc; line-height: 1.8;">
                            <div style="margin-bottom: 10px;">
                                <strong>Recipient Wallet:</strong>
                                <div style="background: #333; padding: 10px; border-radius: 4px; margin-top: 5px; word-break: break-all; font-family: monospace;">
                                    ${walletAddress}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Amount:</strong>
                                <div style="background: #333; padding: 10px; border-radius: 4px; margin-top: 5px; font-size: 1.2em; color: #ff6b00;">
                                    ${currentPayoutEntry.prizeWon} NUTS
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Memo/Note:</strong>
                                <div style="background: #333; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                    Contest Prize - ${currentPayoutEntry.contestDate}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 8px;">
                        <p style="color: #ff6b00; font-weight: bold; margin-bottom: 10px;">Step 2: Send Payment</p>
                        <ol style="color: #ccc; line-height: 1.8; margin: 0; padding-left: 20px;">
                            <li>Open your Xaman wallet</li>
                            <li>Tap "Send"</li>
                            <li>Enter the recipient wallet address</li>
                            <li>Select NUTS from your token list</li>
                            <li>Enter the prize amount</li>
                            <li>Add the memo for reference</li>
                            <li>Review and send</li>
                        </ol>
                    </div>
                    
                    <button onclick="markPayoutComplete()" style="width: 100%; background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold;">
                        ✅ Mark Payout as Complete
                    </button>
                </div>
            `;
        }
        
        async function generatePayoutQR() {
            if (!currentPayoutEntry) return;
            
            // Check if wallet address is available
            if (!currentPayoutEntry.walletAddress) {
                document.getElementById('payment-method-content').innerHTML = `
                    <div style="background: #ff3333; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <p><strong>Wallet address not available!</strong></p>
                        <p style="margin-top: 10px;">The winner's wallet address was not captured during entry.</p>
                        <p>Please use the manual payment option and check the transaction history.</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('payment-method-content').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="color: #ccc; margin-top: 10px;">Generating payment QR code...</p>
                </div>
            `;
            
            try {
                // Call XUMM server to create payout payload
                const response = await fetch('http://localhost:3001/create-nuts-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        destination: currentPayoutEntry.walletAddress || null,
                        amount: currentPayoutEntry.prizeWon.toString(),
                        memo: `Contest Prize - ${currentPayoutEntry.contestDate}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.payload) {
                    document.getElementById('payment-method-content').innerHTML = `
                        <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 2px solid #ff6b00; text-align: center;">
                            <h3 style="color: #ff6b00; margin-bottom: 15px;">📱 Scan to Send Prize</h3>
                            
                            <div style="background: white; padding: 10px; border-radius: 8px; display: inline-block; margin-bottom: 15px;">
                                <img src="${data.payload.refs.qr_png}" width="250" height="250" alt="Payment QR">
                            </div>
                            
                            <div style="color: #ccc; margin-bottom: 15px;">
                                <p><strong>Amount:</strong> ${currentPayoutEntry.prizeWon} NUTS</p>
                                <p><strong>To:</strong> ${currentPayoutEntry.userName}</p>
                            </div>
                            
                            <p style="color: #888; font-size: 0.9em;">
                                Scan with Xaman wallet to send prize payment
                            </p>
                            
                            <button onclick="markPayoutComplete()" style="width: 100%; background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold;">
                                ✅ Payment Sent - Mark Complete
                            </button>
                        </div>
                    `;
                    
                    // Start polling for payment status
                    pollPayoutStatus(data.payload.uuid);
                } else {
                    throw new Error(data.error || 'Failed to generate QR code');
                }
                
            } catch (error) {
                console.error('Failed to generate payout QR:', error);
                document.getElementById('payment-method-content').innerHTML = `
                    <div style="background: #ff3333; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <p>Failed to generate QR code: ${error.message}</p>
                        <p style="margin-top: 10px;">Please use manual payment option.</p>
                    </div>
                `;
            }
        }
        
        async function pollPayoutStatus(uuid) {
            // Poll for payment completion
            let attempts = 0;
            const maxAttempts = 60;
            
            const checkStatus = async () => {
                if (attempts >= maxAttempts) return;
                
                try {
                    const response = await fetch(`http://localhost:3001/payload-status/${uuid}`);
                    const data = await response.json();
                    
                    if (data.meta?.signed === true) {
                        // Payment completed
                        alert('✅ Payout sent successfully!');
                        await markPayoutComplete();
                        return;
                    }
                    
                    if (!data.meta?.resolved) {
                        attempts++;
                        setTimeout(checkStatus, 5000);
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            };
            
            setTimeout(checkStatus, 3000);
        }
        
        function clearSelectedDateData() {
            const dateInput = document.getElementById('contest-date');
            const contestDate = dateInput.value;
            
            if (!contestDate) {
                alert('Please select a date first');
                return;
            }
            
            if (confirm(`Are you sure you want to clear all contest data for ${contestDate}?`)) {
                // Clear contest entries for this date
                const keys = [
                    `contest_entries_${contestDate}`,
                    `entries_${contestDate}`
                ];
                
                keys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        console.log(`🗑️ Removing ${key}`);
                        localStorage.removeItem(key);
                    }
                });
                
                alert(`Cleared contest data for ${contestDate}`);
                loadContestData(); // Reload the page data
            }
        }
        
        function clearTestData() {
            console.log('🗑️ Clearing all test data...');
            
            // Clear all localStorage keys that might contain test data
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (
                    key.includes('contest_entries_') || 
                    key.includes('entries_') || 
                    key.includes('test_') ||
                    key.includes('mock_') ||
                    key.includes('demo_')
                )) {
                    keysToRemove.push(key);
                }
            }
            
            console.log('🗑️ Found test data keys:', keysToRemove);
            
            keysToRemove.forEach(key => {
                console.log(`🗑️ Removing ${key}`);
                localStorage.removeItem(key);
            });
            
            alert(`Cleared ${keysToRemove.length} test data keys. Click Load Data to refresh.`);
        }
        
        function clearAllContestData() {
            if (confirm('Are you sure you want to clear ALL contest data from localStorage? This cannot be undone!')) {
                // Clear all contest-related keys
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('contest_entries_') || key.startsWith('entries_') || key === 'contest_entries')) {
                        keys.push(key);
                    }
                }
                
                keys.forEach(key => {
                    console.log(`🗑️ Removing ${key}`);
                    localStorage.removeItem(key);
                });
                
                alert(`Cleared all contest data (${keys.length} keys removed)`);
                loadContestData(); // Reload the page data
            }
        }
        
        async function completeContest() {
            const dateInput = document.getElementById('contest-date');
            const contestDate = dateInput.value;
            
            if (!contestDate) {
                alert('Please select a contest date first');
                return;
            }
            
            if (!confirm(`Complete contest for ${contestDate}? This will mark all entries as completed and prevent new entries.`)) {
                return;
            }
            
            try {
                console.log(`🏁 Completing contest for ${contestDate}`);
                
                if (backend) {
                    const result = await backend.completeContest(contestDate);
                    
                    if (result.success) {
                        alert(`Contest completed! ${result.entriesCompleted} entries marked as completed.`);
                        loadContestData(); // Reload to show updated status
                    } else {
                        alert('Failed to complete contest: ' + result.error);
                    }
                } else {
                    alert('Backend not initialized');
                }
                
            } catch (error) {
                console.error('Failed to complete contest:', error);
                alert('Error completing contest: ' + error.message);
            }
        }

        async function markPayoutComplete() {
            if (!currentPayoutEntry) return;
            
            try {
                // Update entry status
                currentPayoutEntry.payoutStatus = 'completed';
                currentPayoutEntry.payoutTimestamp = new Date().toISOString();
                
                // In production, update Firebase
                if (integration && integration.db) {
                    await integration.db.collection('contest_entries')
                        .doc(currentPayoutEntry.id)
                        .update({
                            payoutStatus: 'completed',
                            payoutTimestamp: currentPayoutEntry.payoutTimestamp
                        });
                }
                
                alert('✅ Payout marked as complete!');
                closePayoutModal();
                loadContestData(); // Refresh the table
                
            } catch (error) {
                console.error('Failed to update payout status:', error);
                alert('Failed to update payout status: ' + error.message);
            }
        }
    </script>
</body>
</html>